#!/bin/sh

FIND=find
GREP=grep
DIRNAME=dirname
PKGCONFIG=pkg-config

findLuaInclude() {
	local VERSION=$1
	local SEARCHPATH=$2
	local FILE=`$FIND $SEARCHPATH -name luaconf.h | $GREP $VERSION`
	if [ x$FILE != 'x' ]; then
		local RESULT=`$DIRNAME $FILE`
		echo $RESULT
	fi
}

findLuaLib() {
	local VERSION=$1
	local SEARCHPATH=$2
	local FILE=`$FIND $SEARCHPATH -name "liblua$VERSION.so"`
	if [ x$FILE != 'x' ]; then
		local RESULT=`$DIRNAME $FILE`
		echo $RESULT
	fi
}

findLuaBin() {
	local VERSION=$1
	local SEARCHPATH=$2
	local RESULT=`$FIND $PATH -type f -name "lua$VERSION"`
	if [ x$RESULT != 'x' ]; then
		echo $RESULT
	fi
}

writeLuaInclude() {
	local VERSION=$1
	local INCPATH=$2
	local LIBPATH=$3
	local BINPATH=$4
	echo "LUAVER   := $VERSION" > Lua.inc
	echo "LUAINC   := $INCPATH" >> Lua.inc
	echo "LUALIBDIR:= $LIBPATH" >> Lua.inc
	echo "LUABIN   := $BINPATH" >> Lua.inc
	echo "LUALIBS  := -llua$VERSION -L$LIBPATH" >> Lua.inc
}

searchLuaWithPkgConfig() {
	for VERSION in 5.4 5.3 5.2 ; do
		>&2 echo "Checking for version $VERSION ..."
		local LUAVERSION=`$PKGCONFIG --variable=version lua$VERSION`
		if [ x$LUAVERSION != 'x' ]; then
			local INCPATH="`$PKGCONFIG --variable=includedir lua$VERSION`/lua$VERSION"
			local LIBPATH=`$PKGCONFIG --variable=libdir lua$VERSION`
			local PREFIX=`$PKGCONFIG --variable=prefix lua$VERSION`
			if [ x$INCPATH != 'x' ] && [ x$LIBPATH != 'x' ] && [ x$PREFIX != 'x' ] ; then
				local BINPATH="$PREFIX/bin/lua$VERSION"
				writeLuaInclude $VERSION $INCPATH $LIBPATH $BINPATH
				>&2 echo "$PKGCONFIG --variable=includedir lua$VERSION => $INCPATH"
				>&2 echo "$PKGCONFIG --variable=libdir lua$VERSION => $LIBPATH"
				>&2 echo "$PKGCONFIG --variable=prefix lua$VERSION => $PREFIX, BINPATH=$BINPATH"
				>&2 echo "$PKGCONFIG --variable=version lua$VERSION => $LUAVERSION"
				>&2 echo "Wrote file Lua.inc:"
				>&2 cat Lua.inc
				exit 0
			fi
		fi
	done
	exit 1
}

searchLuaWithRawFind() {
	for VERSION in 5.4 5.3 5.2; do
		>&2 echo "Checking for version $VERSION ..."
		local INCPATH=`findLuaInclude $VERSION "/usr/local/include /usr/include"`
		local LIBPATH=`findLuaLib $VERSION "/usr/local/lib /usr/lib"`
		local BINPATH=`findLuaBin $VERSION "/usr/bin /usr/local/bin"`
		if [ x$INCPATH != 'x' ] && [ x$LIBPATH != 'x' ]; then
			writeLuaInclude $VERSION $INCPATH $LIBPATH $BINPATH
			>&2 echo "Lua include path = $INCPATH"
			>&2 echo "Lua library path = $LIBPATH"
			>&2 echo "Lua binary path = $BINPATH"
			>&2 echo "Lua version = $VERSION"
			>&2 echo "Wrote file Lua.inc:"
			>&2 cat Lua.inc
			exit 0
		fi
	done
	exit 1
}

searchLuaWithPkgConfig
if [ $? != 0 ]; then 
	>&2 echo "Failed to determine Lua package info with $PKGCONFIG, now searching with raw find ..."
	searchLuaWithRawFind
	if [ $? != 0 ]; then 
		>&2 echo "Lua installation (version 5.2,5.3 or 5.4) not found!"
		exit 1
	fi
fi


